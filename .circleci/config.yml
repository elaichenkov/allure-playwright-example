# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs: 
  docker: circleci/docker@2.1.1
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  playwright-test:
    docker:
      - image: mcr.microsoft.com/playwright:v1.22.0-focal
    environment:
      NODE_ENV: development
    steps:
      - docker/install-docker
      - run: docker exec -u root -t -i container_id /bin/bash
      - run: sudo apt-get update
      - run: sudo apt install openjdk-8-jdk
      - run: export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      - run: export PATH=$PATH:$JAVA_HOME/bin
      - checkout
      - run: npm install
      - run: npm i -D playwright @playwright/test
      - run: npm i -D experimental-allure-playwright 
      - run: npm i -D allure-commandline
      - run: npx playwright test --reporter=line,experimental-allure-playwright ||true
      - run: npx allure generate ./allure-results --clean
      - run: allure serve allure-results

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  e2e-test-workflow:
    jobs:
      - playwright-test
